{% extends "accounts/base.html" %}
{% load static %}
{% load auth_extras %}

{% block title %}Leads - LeadgenPro{% endblock %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/leads_list.css' %}">
    <link rel="stylesheet" href="{% static 'css/lead_table.css' %}">
    <link rel="stylesheet" href="{% static 'css/lead_interactive.css' %}">
{% endblock %}


{% block content %}
<div class="leads-container">
    <div class="leads-header">
        <h2>Your Leads</h2>
        <div class="header-actions">
            {% if user.is_superuser or user|has_group:"Managers" %}
                <a href="{% url 'leads:upload_leads' %}" class="btn btn-primary">üì§ Upload New Leads</a>
            {% endif %}
            <a href="{% url 'leads:download_sample_csv' %}" class="btn btn-secondary">üì• Download Sample CSV</a>
            
            <div class="col-toggle-btn" id="col-toggle-btn">
                Show/Hide Columns üëÅÔ∏è
                <div class="col-toggle-dropdown" id="col-toggle-dropdown" onclick="event.stopPropagation();">
                    <label><input type="checkbox" data-col="lead_id"> Lead ID</label>
                    <label><input type="checkbox" data-col="full_name" checked> Full Name</label>
                    <label><input type="checkbox" data-col="first_name"> First Name</label>
                    <label><input type="checkbox" data-col="last_name"> Last Name</label>
                    <label><input type="checkbox" data-col="job_title" checked> Job Title</label>
                    <label><input type="checkbox" data-col="prof_email" checked> Professional Email</label>
                    <label><input type="checkbox" data-col="email_status"> Email Status</label>
                    <label><input type="checkbox" data-col="personal_email"> Personal Email</label>
                    <label><input type="checkbox" data-col="li_person" checked> LinkedIn (Person)</label>
                    <label><input type="checkbox" data-col="person_city" checked> Person City</label>
                    <label><input type="checkbox" data-col="person_state"> Person State</label>
                    <label><input type="checkbox" data-col="person_country" checked> Person Country</label>
                    <label><input type="checkbox" data-col="person_phone"> Phone (Person)</label>
                    <label><input type="checkbox" data-col="company_id"> Company ID</label>
                    <label><input type="checkbox" data-col="company_name" checked> Company Name</label>
                    <label><input type="checkbox" data-col="company_website" checked> Company Website</label>
                    <label><input type="checkbox" data-col="industry" checked> Industry</label>
                    <label><input type="checkbox" data-col="employees" checked> Employees</label>
                    <label><input type="checkbox" data-col="revenue" checked> Revenue</label>
                    <label><input type="checkbox" data-col="generic_email"> Generic Email</label>
                    <label><input type="checkbox" data-col="full_address"> Full Address</label>
                    <label><input type="checkbox" data-col="first_address"> First Address</label>
                    <label><input type="checkbox" data-col="company_city" checked> Company City</label>
                    <label><input type="checkbox" data-col="company_state"> Company State</label>
                    <label><input type="checkbox" data-col="zip_code"> Zip Code</label>
                    <label><input type="checkbox" data-col="company_country" checked> Company Country</label>
                    <label><input type="checkbox" data-col="company_phone"> Company Phone</label>
                    <label><input type="checkbox" data-col="company_linkedin" checked> LinkedIn (Company)</label>
                    <label><input type="checkbox" data-col="comments"> Comments</label>
                    <label><input type="checkbox" data-col="source"> Source</label>
                    <label><input type="checkbox" data-col="created_by"> Added By</label>
                </div>
            </div>
        </div>
    </div>

    <div class="leads-filters">
        <form method="get" class="filter-form">
            <div class="filter-grid">
                
                <div class="filter-group">
                    <label for="id_company_name">{{ form.company_name.label }}:</label>
                    {{ form.company_name }}
                </div>
                <div class="filter-group">
                    <label for="id_job_title">{{ form.job_title.label }}:</label>
                    {{ form.job_title }}
                </div>
                <div class="filter-group">
                    <label for="id_industry">{{ form.industry.label }}:</label>
                    {{ form.industry }}
                </div>
                
                <div class="filter-group">
                    <label for="id_employees_dropdown">{{ form.employees_dropdown.label }}:</label>
                    {{ form.employees_dropdown }}
                </div>
                <div class="filter-group">
                    <label for="id_employees_text">{{ form.employees_text.label }}:</label>
                    {{ form.employees_text }}
                </div>

                <div class="filter-group">
                    <label for="id_person_country">{{ form.person_country.label }}:</label>
                    {{ form.person_country }}
                </div>
                <div class="filter-group">
                    <label for="id_company_country">{{ form.company_country.label }}:</label>
                    {{ form.company_country }}
                </div>
                <div class="filter-group">
                    <label for="id_revenue">{{ form.revenue.label }}:</label>
                    {{ form.revenue }}
                </div>
                <div class="filter-group">
                    <label for="id_search">{{ form.search.label }}:</label>
                    {{ form.search }}
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="{% url 'leads:leads_list' %}" class="btn btn-outline">Clear</a>
                </div>
            </div>
        </form>
    </div>

    {# Bulk Action Bar (No change) #}
    <div class="bulk-action-bar" id="bulk-action-bar" style="display: none;">
        <span class="selected-count">
            <strong id="selected-count">0</strong> leads selected
        </span>
        <div class="actions">
            <button class="btn btn-secondary" disabled>Add to List</button>
            <button class="btn btn-secondary" disabled>Email</button>
            <button class="btn btn-secondary" disabled>Delete Selected</button>
            <button class="btn btn-primary" id="bulk-export-btn">Export Selected</button>
        </div>
    </div>

    {# Table (No change) #}
    <div class="table-scroll-wrapper">
        <table class="leads-table">
            <thead>
                <tr>
                    <th class="col-checkbox"><input type="checkbox" id="select-all-leads"></th>
                    <th class="col-lead_id">Lead ID</th>
                    <th class="col-full_name">Full Name</th>
                    <th class="col-first_name">First Name</th>
                    <th class="col-last_name">Last Name</th>
                    <th class="col-job_title">Job Title</th>
                    <th class="col-prof_email">Professional Email</th>
                    <th class="col-email_status">Email Status</th>
                    <th class="col-personal_email">Personal Email</th>
                    <th class="col-li_person">LinkedIn (Person)</th>
                    <th class="col-person_city">Person City</th>
                    <th class="col-person_state">Person State</th>
                    <th class="col-person_country">Person Country</th>
                    <th class="col-person_phone">Phone (Person)</th>
                    <th class="col-company_id">Company ID</th>
                    <th class="col-company_name">Company Name</th>
                    <th class="col-company_website">Company Website</th>
                    <th class="col-industry">Industry</th>
                    <th class="col-employees">Employees</th>
                    <th class="col-revenue">Revenue</th>
                    <th class="col-generic_email">Generic Email</th>
                    <th class="col-full_address">Full Address</th>
                    <th class="col-first_address">First Address</th>
                    <th class="col-company_city">Company City</th>
                    <th class="col-company_state">Company State</th>
                    <th class="col-zip_code">Zip Code</th>
                    <th class="col-company_country">Company Country</th>
                    <th class="col-company_phone">Company Phone</th>
                    <th class="col-company_linkedin">LinkedIn (Company)</th>
                    <th class="col-comments">Comments</th>
                    <th class="col-source">Source</th>
                    <th class="col-created_by">Added By</th>
                </tr>
            </thead>
            <tbody>
                {% for lead in leads %}
                <tr>
                    <td class="col-checkbox">
                        <input type="checkbox" class="lead-checkbox" data-lead-id="{{ lead.id }}">
                    </td>
                    
                    <td class="col-lead_id">{{ lead.lead_id|default:"-" }}</td>
                    <td class="col-full_name">
                        <strong>
                            <a href="#" class="quick-view-btn" data-lead-id="{{ lead.id }}" data-url="{% url 'leads:get_lead_detail_json' lead.pk %}">
                                {{ lead.full_name|default:"-" }}
                            </a>
                        </strong>
                    </td>
                    <td class="col-first_name">{{ lead.first_name|default:"-" }}</td>
                    <td class="col-last_name">{{ lead.last_name|default:"-" }}</td>
                    <td class="col-job_title">{{ lead.job_title|default:"-" }}</td>
                    <td class="col-prof_email">{{ lead.professional_email|default:"-" }}</td>
                    <td class="col-email_status">{{ lead.email_status|default:"-" }}</td>
                    <td class="col-personal_email">{{ lead.personal_email|default:"-" }}</td>
                    <td class="col-li_person">
                        {% if lead.person_linkedin_url %}<a href="{{ lead.person_linkedin_url }}" target="_blank" title="LinkedIn Profile">üë§ Profile</a>{% else %}-{% endif %}
                    </td>
                    <td class="col-person_city">{{ lead.person_city|default:"-" }}</td>
                    <td class="col-person_state">{{ lead.person_state|default:"-" }}</td>
                    <td class="col-person_country">{{ lead.person_country|default:"-" }}</td>
                    <td class="col-person_phone">{{ lead.person_direct_phone|default:"-" }}</td>
                    <td class="col-company_id">{{ lead.company_id|default:"-" }}</td>
                    <td class="col-company_name"><strong>{{ lead.company_name|default:"-" }}</strong></td>
                    <td class="col-company_website">
                        {% if lead.company_website %}<a href="{{ lead.company_website }}" target="_blank" title="Company Website">üåê Website</a>{% else %}-{% endif %}
                    </td>
                    <td class="col-industry">{{ lead.industry|default:"-" }}</td>
                    <td class="col-employees">{{ lead.employees|default:"-" }}</td>
                    <td class="col-revenue">{{ lead.revenue|default:"-" }}</td>
                    <td class="col-generic_email">{{ lead.generic_email|default:"-" }}</td>
                    <td class="col-full_address">{{ lead.full_address|default:"-"|truncatewords:5 }}</td>
                    <td class="col-first_address">{{ lead.first_address|default:"-"|truncatewords:5 }}</td>
                    <td class="col-company_city">{{ lead.company_city|default:"-" }}</td>
                    <td class="col-company_state">{{ lead.company_state|default:"-" }}</td>
                    <td class="col-zip_code">{{ lead.zip_code|default:"-" }}</td>
                    <td class="col-company_country">{{ lead.company_country|default:"-" }}</td>
                    <td class="col-company_phone">{{ lead.company_phone|default:"-" }}</td>
                    <td class="col-company_linkedin">
                        {% if lead.company_linkedin_url %}<a href="{{ lead.company_linkedin_url }}" target="_blank" title="Company LinkedIn">üè¢ Company</a>{% else %}-{% endif %}
                    </td>
                    <td class="col-comments">{{ lead.comments|default:"-"|truncatewords:4 }}</td>
                    <td class="col-source">{{ lead.source|default:"-" }}</td>
                    <td class="col-created_by">{{ lead.created_by.username|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="32" class="text-center no-leads">
                        <div>
                            <p>üìÇ No leads found</p>
                            <a href="{% url 'leads:upload_leads' %}" class="btn btn-primary">Upload Your First Leads</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">&laquo; First</a>
                <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Previous</a>
            {% endif %}
            <span class="current-page">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Last &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>


{# Quick View Drawer HTML (No change) #}
<div class="drawer-overlay" id="drawer-overlay"></div>
<div class="lead-drawer" id="lead-drawer">
    <div class="drawer-header">
        <h3 id="drawer-full-name">Loading...</h3>
        <button class="close-drawer-btn" id="close-drawer-btn">&times;</button>
    </div>
    <div class="drawer-body" id="drawer-content-body">
        <p>Loading details...</p>
    </div>
</div>

{% endblock %}


{% block extra_js %}
    <script src="{% static 'js/lead_table.js' %}" defer></script>
    <script src="{% static 'js/lead_interactive.js' %}" defer></script>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        $(document).ready(function() {
            
            // Multi-select dropdowns ke liye
            $('.select2-multi').select2({
                placeholder: "Select one or more",
                allowClear: true,
                width: '100%'
            });
            
            // Single-select (Employees) dropdown ke liye
            $('.select2-single').select2({
                placeholder: "Select an option",
                allowClear: true,
                width: '100%'
            });

            // Page reload hone par purani selected values ko restore karein
            {% for field in form %}
                {% if field.name in "job_title,industry,person_country,company_country,employees_dropdown" %}
                    var selectedValues_{{ field.name }} = [
                        {% for value in field.value %}
                            "{{ value|escapejs }}",
                        {% endfor %}
                    ];
                    $('#id_{{ field.name }}').val(selectedValues_{{ field.name }}).trigger('change');
                {% endif %}
            {% endfor %}
            
            var selectedEmployeeText = "{{ form.employees_text.value|escapejs }}";
            if (selectedEmployeeText) {
                $('#id_employees_text').val(selectedEmployeeText);
            }

        });
    </script>
{% endblock %}